version: 2.1

executors:
  amd64: # Docker using the Base Convenience Image
    docker:
      - image: docker
    environment:
      PLATFORM: "linux/amd64"
  arm64: # a Linux VM running Ubuntu 20.04
    docker:
      - image: docker
    resource_class: arm.medium
    environment:
      PLATFORM: "linux/arm64"

commands:
  configure-ghcr:
    description: Configure GHCR access
    steps:
      - run:
          name: Configure GHCR
          command: |
            [ -z "$GHCR_TOKEN" ] && exit 0
            [ -z "$GHCR_USER" ] && exit 0
            echo $GHCR_TOKEN | docker login ghcr.io -u $GHCR_USER --password-stdin
jobs:
    build:
      parameters:
        platform:
          type: executor
        target:
          type: string
      executor: << parameters.platform >>
      steps:
        - checkout
        - configure-ghcr
        - setup_remote_docker
        - run:
            name: Build
            command: |
              docker buildx bake --set _platforms.platform=${PLATFORM} << parameters.target >>
    push:
      parameters:
        platform:
          type: executor
        target:
          type: string
      executor: << parameters.platform >>
      steps:
        - checkout
        - configure-ghcr
        - setup_remote_docker
        - run:
            name: Build
            command: |
              docker buildx bake --set _platforms.platform=${PLATFORM} << parameters.target >> --push
workflows:
  build-all:
    jobs:
      - build:
          context: ghcr-token
          matrix:
            parameters:
              platform: [amd64, arm64]
              target: [proxy, server]
      - push:
          context: ghcr-token
          requires:
            - build
          matrix:
            parameters:
              platform: [amd64, arm64]
              target: [proxy, server]


